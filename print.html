<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Preservation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="custom.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Preservation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/nix-community/preservation" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="preservation"><a class="header" href="#preservation">Preservation</a></h1>
<p>Nix tooling to enable declarative management of non-volatile system state.</p>
<p>Inspired and heavily influenced by <a href="https://github.com/nix-community/impermanence">impermanence</a> but not
meant to be a drop-in replacement.</p>
<h2 id="documentation"><a class="header" href="#documentation">Documentation</a></h2>
<p>Docs are available at <a href="https://nix-community.github.io/preservation">https://nix-community.github.io/preservation</a></p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>Requires at least nixos-24.11</p>
<h2 id="why"><a class="header" href="#why">Why?</a></h2>
<p>This aims to provide a declarative state management solution for NixOS systems without resorting to
interpreters to do the heavy lifting. This should enable impermanence-like state management on
an "interpreter-less" NixOS system.</p>
<p>Related:</p>
<ul>
<li><a href="https://github.com/NixOS/nixpkgs/issues/265640">https://github.com/NixOS/nixpkgs/issues/265640</a></li>
<li><a href="https://github.com/nix-community/projects/blob/main/proposals/nixpkgs-security-phase2.md#boot-chain-security">https://github.com/nix-community/projects/blob/main/proposals/nixpkgs-security-phase2.md#boot-chain-security</a></li>
</ul>
<h2 id="license"><a class="header" href="#license">License</a></h2>
<p>This project is released under the terms of the MIT License. See <a href="./LICENSE">LICENSE</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="preservationenable"><a class="header" href="#preservationenable">preservation.enable</a></h2>
<p>Whether to enable the preservation module.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Example:</em>
<code>true</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveat"><a class="header" href="#preservationpreserveat">preservation.preserveAt</a></h2>
<p>Specify a set of locations and the corresponding state that
should be preserved there.</p>
<p><em>Type:</em>
attribute set of (submodule)</p>
<p><em>Default:</em>
<code>{ }</code></p>
<p><em>Example:</em></p>
<pre><code class="language-nix">{
  "/state" = {
    directories = [ "/var/lib/someservice" ];
    files = [
      {
        file = "/etc/wpa_supplicant.conf";
        how = "symlink";
      }
      {
        file = "/etc/machine-id";
        inInitrd = true;
      }
    ];
    users = {
      alice.directories = [ ".rabbit_hole" ];
      butz = {
        files = [
          {
            file = ".config/foo";
            mode = "0600";
          }
          "bar"
        ];
        directories = [ "unshaved_yaks" ];
      };
    };
  };
}
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathcommonmountoptions"><a class="header" href="#preservationpreserveatpathcommonmountoptions">preservation.preserveAt.&lt;path&gt;.commonMountOptions</a></h2>
<p>Specify a list of mount options that should be added to all files and directories
under this preservation prefix, for which <code>how</code> is set to <code>bindmount</code>.</p>
<p>See also <code>commonMountOptions</code> under <code>users</code> and the invdividual
<code>mountOptions</code> that is available per file / directory.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Default:</em>
<code>[ ]</code></p>
<p><em>Example:</em></p>
<pre><code>[
  "x-gvfs-hide"
  "x-gdu.hide"
]
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathcommonmountoptionsname"><a class="header" href="#preservationpreserveatpathcommonmountoptionsname">preservation.preserveAt.&lt;path&gt;.commonMountOptions.*.name</a></h2>
<p>Specify the name of the mount option.</p>
<p><em>Type:</em>
string</p>
<p><em>Example:</em>
<code>"bind"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathcommonmountoptionsvalue"><a class="header" href="#preservationpreserveatpathcommonmountoptionsvalue">preservation.preserveAt.&lt;path&gt;.commonMountOptions.*.value</a></h2>
<p>Optionally specify a value for the mount option.</p>
<p><em>Type:</em>
null or string</p>
<p><em>Default:</em>
<code>null</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathdirectories"><a class="header" href="#preservationpreserveatpathdirectories">preservation.preserveAt.&lt;path&gt;.directories</a></h2>
<p>Specify a list of directories that should be preserved.
The paths are interpreted as absolute paths.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Default:</em>
<code>[ ]</code></p>
<p><em>Example:</em></p>
<pre><code>[
  "/var/lib/someservice"
]
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathdirectoriesconfigureparent"><a class="header" href="#preservationpreserveatpathdirectoriesconfigureparent">preservation.preserveAt.&lt;path&gt;.directories.*.configureParent</a></h2>
<p>Specify whether the parent directory of this directory shall be configured with
custom ownership and permissions.</p>
<p>By default, missing parent directories are always created with ownership
<code>root:root</code> and mode <code>0755</code>, as described in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a>.</p>
<p>Ownership and mode may be configured through the options
<code>parent.user</code>,
<code>parent.group</code>,
<code>parent.mode</code>.</p>
<p>Defaults to <code>true</code> when <code>how</code> is set to <code>symlink</code> and
<code>user</code> is not <code>root</code>.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathdirectoriescreatelinktarget"><a class="header" href="#preservationpreserveatpathdirectoriescreatelinktarget">preservation.preserveAt.&lt;path&gt;.directories.*.createLinkTarget</a></h2>
<p>Only used when <code>how</code> is set to <code>symlink</code>.</p>
<p>Specify whether to create an empty directory with the specified ownership
and permissions as target of the symlink.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathdirectoriesdirectory"><a class="header" href="#preservationpreserveatpathdirectoriesdirectory">preservation.preserveAt.&lt;path&gt;.directories.*.directory</a></h2>
<p>Specify the path to the directory that should be preserved.</p>
<p><em>Type:</em>
string</p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathdirectoriesgroup"><a class="header" href="#preservationpreserveatpathdirectoriesgroup">preservation.preserveAt.&lt;path&gt;.directories.*.group</a></h2>
<p>Specify the group that owns the directory.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"config.users.users.\${defaultOwner}.group"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathdirectorieshow"><a class="header" href="#preservationpreserveatpathdirectorieshow">preservation.preserveAt.&lt;path&gt;.directories.*.how</a></h2>
<p>Specify how this directory should be preserved.</p>
<ol>
<li>
<p>Either a directory is created both on the volatile and on the
persistent volume, with a bind mount from the former to the
latter.</p>
</li>
<li>
<p>Or a symlink is created on the volatile volume, pointing
to the corresponding location on the persistent volume.</p>
</li>
<li>
<p>Finally the option <code>_intermediate</code> exists to handle directories
which are supposed to be created on both the volatile and persistent
volume, but without any preservation of them specifically.</p>
</li>
</ol>
<p><em>Type:</em>
one of “bindmount”, “symlink”, “_intermediate”</p>
<p><em>Default:</em>
<code>"bindmount"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathdirectoriesininitrd"><a class="header" href="#preservationpreserveatpathdirectoriesininitrd">preservation.preserveAt.&lt;path&gt;.directories.*.inInitrd</a></h2>
<p>Whether to prepare preservation of this directory in initrd.</p>
<p><strong>Note:</strong> For most directories there is no need to enable this option.</p>
<p><strong>Important:</strong> Note that both owner and group for this directory need to be
available in the initrd for permissions to be set correctly.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathdirectoriesmode"><a class="header" href="#preservationpreserveatpathdirectoriesmode">preservation.preserveAt.&lt;path&gt;.directories.*.mode</a></h2>
<p>Specify the access mode of the directory.
See the section <code>Mode</code> in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a> for more information.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"0755"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathdirectoriesmountoptions"><a class="header" href="#preservationpreserveatpathdirectoriesmountoptions">preservation.preserveAt.&lt;path&gt;.directories.*.mountOptions</a></h2>
<p>Specify a list of mount options that should be used for this directory.
These options are only used when <code>how</code> is set to <code>bindmount</code>.
By default, <code>bind</code> and <code>X-fstrim.notrim</code> are added,
use <code>mkForce</code> to override these if needed.
See also <code>fstrim(8)</code>.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathdirectoriesmountoptionsname"><a class="header" href="#preservationpreserveatpathdirectoriesmountoptionsname">preservation.preserveAt.&lt;path&gt;.directories.*.mountOptions.*.name</a></h2>
<p>Specify the name of the mount option.</p>
<p><em>Type:</em>
string</p>
<p><em>Example:</em>
<code>"bind"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathdirectoriesmountoptionsvalue"><a class="header" href="#preservationpreserveatpathdirectoriesmountoptionsvalue">preservation.preserveAt.&lt;path&gt;.directories.*.mountOptions.*.value</a></h2>
<p>Optionally specify a value for the mount option.</p>
<p><em>Type:</em>
null or string</p>
<p><em>Default:</em>
<code>null</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathdirectoriesparentgroup"><a class="header" href="#preservationpreserveatpathdirectoriesparentgroup">preservation.preserveAt.&lt;path&gt;.directories.*.parent.group</a></h2>
<p>Specify the group that owns the parent directory of this file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"config.users.users.\${defaultOwner}.group"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathdirectoriesparentmode"><a class="header" href="#preservationpreserveatpathdirectoriesparentmode">preservation.preserveAt.&lt;path&gt;.directories.*.parent.mode</a></h2>
<p>Specify the access mode of the parent directory of this file.
See the section <code>Mode</code> in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a> for more information.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"0755"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathdirectoriesparentuser"><a class="header" href="#preservationpreserveatpathdirectoriesparentuser">preservation.preserveAt.&lt;path&gt;.directories.*.parent.user</a></h2>
<p>Specify the user that owns the parent directory of this file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"root"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathdirectoriesuser"><a class="header" href="#preservationpreserveatpathdirectoriesuser">preservation.preserveAt.&lt;path&gt;.directories.*.user</a></h2>
<p>Specify the user that owns the directory.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"root"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathfiles"><a class="header" href="#preservationpreserveatpathfiles">preservation.preserveAt.&lt;path&gt;.files</a></h2>
<p>Specify a list of files that should be preserved.
The paths are interpreted as absolute paths.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Default:</em>
<code>[ ]</code></p>
<p><em>Example:</em></p>
<pre><code class="language-nix">[
  {
    file = "/etc/wpa_supplicant.conf";
    how = "symlink";
  }
  {
    file = "/etc/machine-id";
    inInitrd = true;
  }
]
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathfilesconfigureparent"><a class="header" href="#preservationpreserveatpathfilesconfigureparent">preservation.preserveAt.&lt;path&gt;.files.*.configureParent</a></h2>
<p>Specify whether the parent directory of this file shall be configured with
custom ownership and permissions.</p>
<p>By default, missing parent directories are always created with ownership
<code>root:root</code> and mode <code>0755</code>, as described in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a>.</p>
<p>Ownership and mode may be configured through the options
<code>parent.user</code>,
<code>parent.group</code>,
<code>parent.mode</code>.</p>
<p>Defaults to <code>true</code> when <code>how</code> is set to <code>symlink</code> and
<code>user</code> is not <code>root</code>.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathfilescreatelinktarget"><a class="header" href="#preservationpreserveatpathfilescreatelinktarget">preservation.preserveAt.&lt;path&gt;.files.*.createLinkTarget</a></h2>
<p>Only used when <code>how</code> is set to <code>symlink</code>.</p>
<p>Specify whether to create an empty file with the specified ownership
and permissions as target of the symlink.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathfilesfile"><a class="header" href="#preservationpreserveatpathfilesfile">preservation.preserveAt.&lt;path&gt;.files.*.file</a></h2>
<p>Specify the path to the file that should be preserved.</p>
<p><em>Type:</em>
string</p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathfilesgroup"><a class="header" href="#preservationpreserveatpathfilesgroup">preservation.preserveAt.&lt;path&gt;.files.*.group</a></h2>
<p>Specify the group that owns the file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"config.users.users.\${defaultOwner}.group"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathfileshow"><a class="header" href="#preservationpreserveatpathfileshow">preservation.preserveAt.&lt;path&gt;.files.*.how</a></h2>
<p>Specify how this file should be preserved:</p>
<ol>
<li>
<p>Either a file is placed both on the volatile and on the
persistent volume, with a bind mount from the former to the
latter.</p>
</li>
<li>
<p>Or a symlink is created on the volatile volume, pointing
to the corresponding location on the persistent volume.</p>
</li>
</ol>
<p><em>Type:</em>
one of “bindmount”, “symlink”</p>
<p><em>Default:</em>
<code>"bindmount"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathfilesininitrd"><a class="header" href="#preservationpreserveatpathfilesininitrd">preservation.preserveAt.&lt;path&gt;.files.*.inInitrd</a></h2>
<p>Whether to prepare preservation of this file in the initrd.</p>
<p><strong>Note:</strong> For most files there is no need to enable this option.</p>
<p><code>/etc/machine-id</code> is an exception because it needs to
be populated/read very early.</p>
<p><strong>Important:</strong> Note that both owner and group for this file need to be
available in the initrd for permissions to be set correctly.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathfilesmode"><a class="header" href="#preservationpreserveatpathfilesmode">preservation.preserveAt.&lt;path&gt;.files.*.mode</a></h2>
<p>Specify the access mode of the file.
See the section <code>Mode</code> in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a> for more information.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"0644"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathfilesmountoptions"><a class="header" href="#preservationpreserveatpathfilesmountoptions">preservation.preserveAt.&lt;path&gt;.files.*.mountOptions</a></h2>
<p>Specify a list of mount options that should be used for this file.
These options are only used when <code>how</code> is set to <code>bindmount</code>.
By default, <code>bind</code> is added,
use <code>mkForce</code> to override this if needed.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathfilesmountoptionsname"><a class="header" href="#preservationpreserveatpathfilesmountoptionsname">preservation.preserveAt.&lt;path&gt;.files.*.mountOptions.*.name</a></h2>
<p>Specify the name of the mount option.</p>
<p><em>Type:</em>
string</p>
<p><em>Example:</em>
<code>"bind"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathfilesmountoptionsvalue"><a class="header" href="#preservationpreserveatpathfilesmountoptionsvalue">preservation.preserveAt.&lt;path&gt;.files.*.mountOptions.*.value</a></h2>
<p>Optionally specify a value for the mount option.</p>
<p><em>Type:</em>
null or string</p>
<p><em>Default:</em>
<code>null</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathfilesparentgroup"><a class="header" href="#preservationpreserveatpathfilesparentgroup">preservation.preserveAt.&lt;path&gt;.files.*.parent.group</a></h2>
<p>Specify the group that owns the parent directory of this file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"config.users.users.\${defaultOwner}.group"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathfilesparentmode"><a class="header" href="#preservationpreserveatpathfilesparentmode">preservation.preserveAt.&lt;path&gt;.files.*.parent.mode</a></h2>
<p>Specify the access mode of the parent directory of this file.
See the section <code>Mode</code> in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a> for more information.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"0755"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathfilesparentuser"><a class="header" href="#preservationpreserveatpathfilesparentuser">preservation.preserveAt.&lt;path&gt;.files.*.parent.user</a></h2>
<p>Specify the user that owns the parent directory of this file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"root"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathfilesuser"><a class="header" href="#preservationpreserveatpathfilesuser">preservation.preserveAt.&lt;path&gt;.files.*.user</a></h2>
<p>Specify the user that owns the file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"root"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathpersistentstoragepath"><a class="header" href="#preservationpreserveatpathpersistentstoragepath">preservation.preserveAt.&lt;path&gt;.persistentStoragePath</a></h2>
<p>Specify the location at which the <code>directories</code>, <code>files</code>,
<code>users.directories</code> and <code>users.files</code> should be preserved.
Defaults to the name of the parent attribute set.</p>
<p><em>Type:</em>
path</p>
<p><em>Default:</em>
<code>"‹name›"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusers"><a class="header" href="#preservationpreserveatpathusers">preservation.preserveAt.&lt;path&gt;.users</a></h2>
<p>Specify a set of users with corresponding files and directories that
should be preserved.</p>
<p><em>Type:</em>
attribute set of (submodule)</p>
<p><em>Default:</em>
<code>{ }</code></p>
<p><em>Example:</em></p>
<pre><code class="language-nix">{
  alice.directories = [ ".rabbit_hole" ];
  butz = {
    files = [
      {
        file = ".config/foo";
        mode = "0600";
      }
      "bar"
    ];
    directories = [ "unshaved_yaks" ];
  };
}
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersusercommonmountoptions"><a class="header" href="#preservationpreserveatpathusersusercommonmountoptions">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.commonMountOptions</a></h2>
<p>Specify a list of mount options that should be added to all files and directories
of this user, for which <code>how</code> is set to <code>bindmount</code>.</p>
<p>See also the top level <code>commonMountOptions</code> and the invdividual
<code>mountOptions</code> that is available per file / directory.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Default:</em>
<code>[ ]</code></p>
<p><em>Example:</em></p>
<pre><code>[
  "x-gvfs-hide"
  "x-gdu.hide"
]
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersusercommonmountoptionsname"><a class="header" href="#preservationpreserveatpathusersusercommonmountoptionsname">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.commonMountOptions.*.name</a></h2>
<p>Specify the name of the mount option.</p>
<p><em>Type:</em>
string</p>
<p><em>Example:</em>
<code>"bind"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersusercommonmountoptionsvalue"><a class="header" href="#preservationpreserveatpathusersusercommonmountoptionsvalue">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.commonMountOptions.*.value</a></h2>
<p>Optionally specify a value for the mount option.</p>
<p><em>Type:</em>
null or string</p>
<p><em>Default:</em>
<code>null</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserdirectories"><a class="header" href="#preservationpreserveatpathusersuserdirectories">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.directories</a></h2>
<p>Specify a list of directories that should be preserved for this user.
The paths are interpreted relative to <code>home</code>.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Default:</em>
<code>[ ]</code></p>
<p><em>Example:</em></p>
<pre><code>[
  ".rabbit_hole"
]
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserdirectoriesconfigureparent"><a class="header" href="#preservationpreserveatpathusersuserdirectoriesconfigureparent">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.directories.*.configureParent</a></h2>
<p>Specify whether the parent directory of this directory shall be configured with
custom ownership and permissions.</p>
<p>By default, missing parent directories are always created with ownership
<code>root:root</code> and mode <code>0755</code>, as described in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a>.</p>
<p>Ownership and mode may be configured through the options
<code>parent.user</code>,
<code>parent.group</code>,
<code>parent.mode</code>.</p>
<p>Defaults to <code>true</code> when <code>how</code> is set to <code>symlink</code> and
<code>user</code> is not <code>root</code>.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserdirectoriescreatelinktarget"><a class="header" href="#preservationpreserveatpathusersuserdirectoriescreatelinktarget">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.directories.*.createLinkTarget</a></h2>
<p>Only used when <code>how</code> is set to <code>symlink</code>.</p>
<p>Specify whether to create an empty directory with the specified ownership
and permissions as target of the symlink.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserdirectoriesdirectory"><a class="header" href="#preservationpreserveatpathusersuserdirectoriesdirectory">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.directories.*.directory</a></h2>
<p>Specify the path to the directory that should be preserved.</p>
<p><em>Type:</em>
string</p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserdirectoriesgroup"><a class="header" href="#preservationpreserveatpathusersuserdirectoriesgroup">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.directories.*.group</a></h2>
<p>Specify the group that owns the directory.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"config.users.users.\${defaultOwner}.group"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserdirectorieshow"><a class="header" href="#preservationpreserveatpathusersuserdirectorieshow">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.directories.*.how</a></h2>
<p>Specify how this directory should be preserved.</p>
<ol>
<li>
<p>Either a directory is created both on the volatile and on the
persistent volume, with a bind mount from the former to the
latter.</p>
</li>
<li>
<p>Or a symlink is created on the volatile volume, pointing
to the corresponding location on the persistent volume.</p>
</li>
<li>
<p>Finally the option <code>_intermediate</code> exists to handle directories
which are supposed to be created on both the volatile and persistent
volume, but without any preservation of them specifically.</p>
</li>
</ol>
<p><em>Type:</em>
one of “bindmount”, “symlink”, “_intermediate”</p>
<p><em>Default:</em>
<code>"bindmount"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserdirectoriesininitrd"><a class="header" href="#preservationpreserveatpathusersuserdirectoriesininitrd">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.directories.*.inInitrd</a></h2>
<p>Whether to prepare preservation of this directory in initrd.</p>
<p><strong>Note:</strong> For most directories there is no need to enable this option.</p>
<p><strong>Important:</strong> Note that both owner and group for this directory need to be
available in the initrd for permissions to be set correctly.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserdirectoriesmode"><a class="header" href="#preservationpreserveatpathusersuserdirectoriesmode">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.directories.*.mode</a></h2>
<p>Specify the access mode of the directory.
See the section <code>Mode</code> in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a> for more information.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"0755"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserdirectoriesmountoptions"><a class="header" href="#preservationpreserveatpathusersuserdirectoriesmountoptions">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.directories.*.mountOptions</a></h2>
<p>Specify a list of mount options that should be used for this directory.
These options are only used when <code>how</code> is set to <code>bindmount</code>.
By default, <code>bind</code> and <code>X-fstrim.notrim</code> are added,
use <code>mkForce</code> to override these if needed.
See also <code>fstrim(8)</code>.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserdirectoriesmountoptionsname"><a class="header" href="#preservationpreserveatpathusersuserdirectoriesmountoptionsname">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.directories.*.mountOptions.*.name</a></h2>
<p>Specify the name of the mount option.</p>
<p><em>Type:</em>
string</p>
<p><em>Example:</em>
<code>"bind"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserdirectoriesmountoptionsvalue"><a class="header" href="#preservationpreserveatpathusersuserdirectoriesmountoptionsvalue">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.directories.*.mountOptions.*.value</a></h2>
<p>Optionally specify a value for the mount option.</p>
<p><em>Type:</em>
null or string</p>
<p><em>Default:</em>
<code>null</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserdirectoriesparentgroup"><a class="header" href="#preservationpreserveatpathusersuserdirectoriesparentgroup">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.directories.*.parent.group</a></h2>
<p>Specify the group that owns the parent directory of this file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"config.users.users.\${defaultOwner}.group"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserdirectoriesparentmode"><a class="header" href="#preservationpreserveatpathusersuserdirectoriesparentmode">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.directories.*.parent.mode</a></h2>
<p>Specify the access mode of the parent directory of this file.
See the section <code>Mode</code> in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a> for more information.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"0755"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserdirectoriesparentuser"><a class="header" href="#preservationpreserveatpathusersuserdirectoriesparentuser">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.directories.*.parent.user</a></h2>
<p>Specify the user that owns the parent directory of this file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"‹name›"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserdirectoriesuser"><a class="header" href="#preservationpreserveatpathusersuserdirectoriesuser">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.directories.*.user</a></h2>
<p>Specify the user that owns the directory.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"‹name›"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserfiles"><a class="header" href="#preservationpreserveatpathusersuserfiles">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.files</a></h2>
<p>Specify a list of files that should be preserved for this user.
The paths are interpreted relative to <code>home</code>.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Default:</em>
<code>[ ]</code></p>
<p><em>Example:</em></p>
<pre><code class="language-nix">[
  {
    file = ".config/foo";
    mode = "0600";
  }
  "bar"
]
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserfilesconfigureparent"><a class="header" href="#preservationpreserveatpathusersuserfilesconfigureparent">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.files.*.configureParent</a></h2>
<p>Specify whether the parent directory of this file shall be configured with
custom ownership and permissions.</p>
<p>By default, missing parent directories are always created with ownership
<code>root:root</code> and mode <code>0755</code>, as described in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a>.</p>
<p>Ownership and mode may be configured through the options
<code>parent.user</code>,
<code>parent.group</code>,
<code>parent.mode</code>.</p>
<p>Defaults to <code>true</code> when <code>how</code> is set to <code>symlink</code> and
<code>user</code> is not <code>root</code>.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserfilescreatelinktarget"><a class="header" href="#preservationpreserveatpathusersuserfilescreatelinktarget">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.files.*.createLinkTarget</a></h2>
<p>Only used when <code>how</code> is set to <code>symlink</code>.</p>
<p>Specify whether to create an empty file with the specified ownership
and permissions as target of the symlink.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserfilesfile"><a class="header" href="#preservationpreserveatpathusersuserfilesfile">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.files.*.file</a></h2>
<p>Specify the path to the file that should be preserved.</p>
<p><em>Type:</em>
string</p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserfilesgroup"><a class="header" href="#preservationpreserveatpathusersuserfilesgroup">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.files.*.group</a></h2>
<p>Specify the group that owns the file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"config.users.users.\${defaultOwner}.group"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserfileshow"><a class="header" href="#preservationpreserveatpathusersuserfileshow">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.files.*.how</a></h2>
<p>Specify how this file should be preserved:</p>
<ol>
<li>
<p>Either a file is placed both on the volatile and on the
persistent volume, with a bind mount from the former to the
latter.</p>
</li>
<li>
<p>Or a symlink is created on the volatile volume, pointing
to the corresponding location on the persistent volume.</p>
</li>
</ol>
<p><em>Type:</em>
one of “bindmount”, “symlink”</p>
<p><em>Default:</em>
<code>"bindmount"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserfilesininitrd"><a class="header" href="#preservationpreserveatpathusersuserfilesininitrd">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.files.*.inInitrd</a></h2>
<p>Whether to prepare preservation of this file in the initrd.</p>
<p><strong>Note:</strong> For most files there is no need to enable this option.</p>
<p><code>/etc/machine-id</code> is an exception because it needs to
be populated/read very early.</p>
<p><strong>Important:</strong> Note that both owner and group for this file need to be
available in the initrd for permissions to be set correctly.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserfilesmode"><a class="header" href="#preservationpreserveatpathusersuserfilesmode">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.files.*.mode</a></h2>
<p>Specify the access mode of the file.
See the section <code>Mode</code> in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a> for more information.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"0644"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserfilesmountoptions"><a class="header" href="#preservationpreserveatpathusersuserfilesmountoptions">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.files.*.mountOptions</a></h2>
<p>Specify a list of mount options that should be used for this file.
These options are only used when <code>how</code> is set to <code>bindmount</code>.
By default, <code>bind</code> is added,
use <code>mkForce</code> to override this if needed.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserfilesmountoptionsname"><a class="header" href="#preservationpreserveatpathusersuserfilesmountoptionsname">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.files.*.mountOptions.*.name</a></h2>
<p>Specify the name of the mount option.</p>
<p><em>Type:</em>
string</p>
<p><em>Example:</em>
<code>"bind"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserfilesmountoptionsvalue"><a class="header" href="#preservationpreserveatpathusersuserfilesmountoptionsvalue">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.files.*.mountOptions.*.value</a></h2>
<p>Optionally specify a value for the mount option.</p>
<p><em>Type:</em>
null or string</p>
<p><em>Default:</em>
<code>null</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserfilesparentgroup"><a class="header" href="#preservationpreserveatpathusersuserfilesparentgroup">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.files.*.parent.group</a></h2>
<p>Specify the group that owns the parent directory of this file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"config.users.users.\${defaultOwner}.group"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserfilesparentmode"><a class="header" href="#preservationpreserveatpathusersuserfilesparentmode">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.files.*.parent.mode</a></h2>
<p>Specify the access mode of the parent directory of this file.
See the section <code>Mode</code> in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a> for more information.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"0755"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserfilesparentuser"><a class="header" href="#preservationpreserveatpathusersuserfilesparentuser">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.files.*.parent.user</a></h2>
<p>Specify the user that owns the parent directory of this file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"‹name›"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserfilesuser"><a class="header" href="#preservationpreserveatpathusersuserfilesuser">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.files.*.user</a></h2>
<p>Specify the user that owns the file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"‹name›"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserhome"><a class="header" href="#preservationpreserveatpathusersuserhome">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.home</a></h2>
<p>Specify the path to the user’s home directory.</p>
<p><em>Type:</em>
path, not containing newlines or colons</p>
<p><em>Default:</em>
<code>"config.users.users.\${name}.home"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatpathusersuserusername"><a class="header" href="#preservationpreserveatpathusersuserusername">preservation.preserveAt.&lt;path&gt;.users.&lt;user&gt;.username</a></h2>
<p>Specify the user for which the <code>directories</code> and <code>files</code>
should be persisted. Defaults to the name of the parent attribute set.</p>
<p><em>Type:</em>
string, not containing newlines or colons</p>
<p><em>Default:</em>
<code>"‹name›"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/nix-community/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="examples"><a class="header" href="#examples">Examples</a></h1>
<p>See <a href="./configuration-options.html">Configuration Options</a> for all available options.</p>
<h2 id="simple"><a class="header" href="#simple">Simple</a></h2>
<pre><code class="language-nix"># configuration.nix
{
  config,
  lib,
  pkgs,
  ...
}:
{
  preservation = {
    enable = true;
    preserveAt."/persistent" = {
      files = [
        # auto-generated machine ID
        { file = "/etc/machine-id"; inInitrd = true; }
      ];
      directories = [
        "/var/lib/systemd/timers"
        # NixOS user state
        "/var/lib/nixos"
        "/var/log"
      ];
    };
  };

  # systemd-machine-id-commit.service would fail, but it is not relevant
  # in this specific setup for a persistent machine-id so we disable it
  #
  # see the firstboot example below for an alternative approach
  systemd.suppressedSystemUnits = [ "systemd-machine-id-commit.service" ];

}
</code></pre>
<h2 id="compatibility-with-systemds-conditionfirstboot"><a class="header" href="#compatibility-with-systemds-conditionfirstboot">Compatibility with systemd's <code>ConditionFirstBoot</code></a></h2>
<p>In this example the machine-id is preserved on the persistent volume via symlink
instead of a bind-mount. The option <code>configureParent</code> causes the parent directory
of the symlink's target, i.e. <code>/persistent/etc/</code> to be created.
Additionally, <code>systemd-machine-id-commit.service</code> is adapted to persist the tmpfs
mount created by system to the persistent volume.</p>
<pre><code class="language-nix"># configuration.nix
{
  config,
  lib,
  pkgs,
  ...
}:
{
  preservation = {
    enable = true;
    preserveAt."/persistent" = {
      files = [
        # auto-generated machine ID
        { file = "/etc/machine-id"; inInitrd = true; how = "symlink"; configureParent = true; }
        # ...
      ];
      directories = [
        # ...
      ];
    };
  };

  # systemd-machine-id-commit.service would fail, but it is not relevant
  # in this specific setup for a persistent machine-id so we disable it
  #
  # see the firstboot example below for an alternative approach
  systemd.suppressedSystemUnits = [ "systemd-machine-id-commit.service" ];

  # let the service commit the transient ID to the persistent volume
  systemd.services.systemd-machine-id-commit = {
    unitConfig.ConditionPathIsMountPoint = [
      ""
      "/persistent/etc/machine-id"
    ];
    serviceConfig.ExecStart = [
      ""
      "systemd-machine-id-setup --commit --root /persistent"
    ];
  };
}
</code></pre>
<h2 id="complex"><a class="header" href="#complex">Complex</a></h2>
<pre><code class="language-nix"># configuration.nix
{
  config,
  lib,
  pkgs,
  ...
}:
{
  preservation = {
    # the module doesn't do anything unless it is enabled
    enable = true;

    preserveAt."/persistent" = {

      # preserve system directories
      directories = [
        "/etc/secureboot"
        "/var/lib/bluetooth"
        "/var/lib/fprint"
        "/var/lib/fwupd"
        "/var/lib/libvirt"
        "/var/lib/power-profiles-daemon"
        "/var/lib/systemd/coredump"
        "/var/lib/systemd/rfkill"
        "/var/lib/systemd/timers"
        "/var/log"
        { directory = "/var/lib/nixos"; inInitrd = true; }
      ];

      # preserve system files
      files = [
        { file = "/etc/machine-id"; inInitrd = true; }
        { file = "/etc/ssh/ssh_host_rsa_key"; how = "symlink"; configureParent = true; }
        { file = "/etc/ssh/ssh_host_ed25519_key"; how = "symlink"; configureParent = true; }
        "/var/lib/usbguard/rules.conf"

        # creates a symlink on the volatile root
        # creates an empty directory on the persistent volume, i.e. /persistent/var/lib/systemd
        # does not create an empty file at the symlink's target (would require `createLinkTarget = true`)
        { file = "/var/lib/systemd/random-seed"; how = "symlink"; inInitrd = true; configureParent = true; }
      ];

      # preserve user-specific files, implies ownership
      users = {
        butz = {
          commonMountOptions = [
            "x-gvfs-hide"
          ];
          directories = [
            { directory = ".ssh"; mode = "0700"; }
            ".config/syncthing"
            ".config/Element"
            ".local/state/nvim"
            ".local/state/wireplumber"
            ".local/share/direnv"
            ".local/state/nix"
            ".mozilla"
          ];
          files = [
            ".histfile"
          ];
        };
        root = {
          # specify user home when it is not `/home/${user}`
          home = "/root";
          directories = [
            { directory = ".ssh"; mode = "0700"; }
          ];
        };
      };
    };
  };

  # Create some directories with custom permissions.
  #
  # In this configuration the path `/home/butz/.local` is not an immediate parent
  # of any persisted file, so it would be created with the systemd-tmpfiles default
  # ownership `root:root` and mode `0755`. This would mean that the user `butz`
  # could not create other files or directories inside `/home/butz/.local`.
  #
  # Therefore systemd-tmpfiles is used to prepare such directories with
  # appropriate permissions.
  #
  # Note that immediate parent directories of persisted files can also be
  # configured with ownership and permissions from the `parent` settings if
  # `configureParent = true` is set for the file.
  systemd.tmpfiles.settings.preservation = {
    "/home/butz/.config".d = { user = "butz"; group = "users"; mode = "0755"; };
    "/home/butz/.local".d = { user = "butz"; group = "users"; mode = "0755"; };
    "/home/butz/.local/share".d = { user = "butz"; group = "users"; mode = "0755"; };
    "/home/butz/.local/state".d = { user = "butz"; group = "users"; mode = "0755"; };
  };

}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="impermanence"><a class="header" href="#impermanence">Impermanence</a></h1>
<p><a href="https://github.com/nix-community/impermanence">Impermanence</a> is the established solution for managing persistent state on NixOS systems.
Preservation is inspired and heavily influenced by impermanence.</p>
<p>See <a href="./impermanence-comparison.html">Comparison</a> for a high-level overview of their differences.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-does-preservation-compare-to-impermanence"><a class="header" href="#how-does-preservation-compare-to-impermanence">How does Preservation compare to <a href="https://github.com/nix-community/impermanence">impermanence</a></a></h1>
<h3 id="preservation-does-not-attempt-to-be-a-very-generic-solution"><a class="header" href="#preservation-does-not-attempt-to-be-a-very-generic-solution">Preservation does not attempt to be a very generic solution</a></h3>
<p>Preservation tries to fill a specific niche.
For instance, Preservation does not support non-NixOS systems via home-manager, which is supported
by impermanence. See <a href="./impermanence-migration.html">Migration</a> for more technical details.</p>
<h3 id="preservation-only-generates-static-configuration"><a class="header" href="#preservation-only-generates-static-configuration">Preservation only generates static configuration</a></h3>
<p>That is configuration for <a href="https://www.freedesktop.org/software/systemd/man/latest/systemd-tmpfiles.html">systemd-tmpfiles</a>
and systemd <a href="https://www.freedesktop.org/software/systemd/man/latest/systemd.mount.html">mount units</a>.
This makes Preservation a potential candidate for state management on interpreter-less NixOS systems.</p>
<p>Impermanence makes use of NixOS activation scripts and custom systemd services with bash (at the point
of writing this), to create files and directories, setup mounts and configure ownership and permissions (see next point).</p>
<h3 id="preservation-must-be-precisely-configured"><a class="header" href="#preservation-must-be-precisely-configured">Preservation must be precisely configured</a></h3>
<p>There is no <a href="https://github.com/nix-community/impermanence/blob/23c1f06316b67cb5dabdfe2973da3785cfe9c34a/mount-file.bash#L31-L42">special runtime logic</a>
in place. This means that the user must define:</p>
<ul>
<li>when the preservation should be set up: either in the initrd, or after (the default)</li>
<li>how the preservation should be set up: either by symlink, or bindmount (the default)</li>
<li>whether or not parent directories of the persisted files require special permissions</li>
</ul>
<p>See <a href="./impermanence-migration.html">Migration</a> for specifics that need to be considered when coming from an impermanence setup.</p>
<h3 id="similar-configuration"><a class="header" href="#similar-configuration">Similar configuration</a></h3>
<p>Preservation's configuration is based on, and very similar to that of impermanence. See <a href="./impermanence-migration.html">Migration</a> for technical details.</p>
<h3 id="global-enable-option"><a class="header" href="#global-enable-option">Global <code>enable</code> option</a></h3>
<p>Preservation uses a global <code>enable</code> option, impermanence does not.</p>
<p>For thoughts on the <code>enable</code> option, see the discussion at <a href="https://github.com/nix-community/impermanence/pull/171">https://github.com/nix-community/impermanence/pull/171</a> and for available configuration options see <a href="./configuration-options.html">Configuration Options</a>.</p>
<h3 id="no-generic-hidemounts-option"><a class="header" href="#no-generic-hidemounts-option">No generic <code>hideMounts</code> option</a></h3>
<p>Preservation does not provide the same <code>hideMounts</code> option as impermanence, which would set the mount option <code>x-gvfs-hide</code> for bind-mounts.
Instead, preservation allows for the configuration of arbitrary mount options that are propagated to all bind-mounts, both on the top level
of a preserved prefix, and on the per-user level. This can be done via <code>commonMountOptions</code> and would for example enable users to choose
between <code>x-gvfs-hide</code> and <code>x-gdu.hide</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="migration-from-impermanence-to-preservation"><a class="header" href="#migration-from-impermanence-to-preservation">Migration from impermanence to Preservation</a></h1>
<p>This section lists individual differences between impermanence and
Preservation, to better understand them in context of a complete configuration
<a href="./examples.html">Examples</a> may be helpful.</p>
<p>The following points need to be considered when migrating an existing
impermanence configuration to Preservation:</p>
<h3 id="global-enable-switch"><a class="header" href="#global-enable-switch">Global <code>enable</code> switch</a></h3>
<p>The module must be explicitly enabled by setting <code>preservation.enable</code> to <code>true</code>.</p>
<h3 id="handling-of-existing-state"><a class="header" href="#handling-of-existing-state">Handling of existing state</a></h3>
<p>Coming from a setup with impermanence it is important to make sure existing persistent state is preserved
correctly, meaning the ownership and mode of preservation remains the same. There is no exhaustive list
of files and directories requiring special treatment but at least the following needs to be considered:</p>
<p><strong>SSH host keys</strong></p>
<p>Correct ownership and mode of SSH host keys is very important for sshd to accept connections.
Getting this wrong, e.g. not restricted enough, may cause your host to become inaccessible via SSH, forcing
you to use other means of logging into the machine.</p>
<p>The following config may be used to preserve the RSA and Ed25519 host keys with preservation:</p>
<pre><code class="language-nix">preservation.preserveAt."/persistent".files = [
  { file = "/etc/ssh/ssh_host_rsa_key"; how = "symlink"; configureParent = true; }
  { file = "/etc/ssh/ssh_host_ed25519_key"; how = "symlink"; configureParent = true; }
];
</code></pre>
<p>The above config does not include access modes for the key files because the preservation
mode is <code>symlink</code> and the link's target is not touched by preservation without an explicit
<code>createLinkTarget = true</code>.</p>
<p><strong>Secrets and other files requiring special access modes</strong></p>
<p>Any files and directories that need to have a mode that differs from the default (<code>0644</code> for files
and <code>0755</code> for directories) must be configured explicitly to avoid having the default mode applied.</p>
<h3 id="when-to-persist"><a class="header" href="#when-to-persist">When to persist</a></h3>
<p>Files and directories that need to be persisted early, must be explicitly configured. For example <code>/etc/machine-id</code>:</p>
<p>This file needs to be persisted very early, by explicitly setting <code>inInitrd</code> to <code>true</code>:</p>
<pre><code class="language-nix">preservation.preserveAt."/persistent".files = [
  { file = "/etc/machine-id"; inInitrd = true; }
];
</code></pre>
<h3 id="how-to-persist"><a class="header" href="#how-to-persist">How to persist</a></h3>
<p>The mode of preservation must be set explicitly for some files and directories.
This can be done by setting <code>how</code> to either <code>symlink</code> or <code>bindmount</code> (default).
For most cases the default is sufficient but sometimes a symlink may be needed,
for example <code>/var/lib/systemd/random-seed</code>.</p>
<p>This file is expected to not exist before it is initialized. A symlink can be
used to cause its creation to happen on the persistent volume:</p>
<pre><code class="language-nix">preservation.preserveAt."/persistent".files = [
  {
    file = "/var/lib/systemd/random-seed";
    # create a symlink on the volatile volume
    how = "symlink";
    # prepare the preservation early during startup
    inInitrd = true;
  }
];
</code></pre>
<p>Note that no file is created at the symlink's target, unless <code>createLinkTarget</code> is set to <code>true</code>.</p>
<h3 id="intermediate-path-components"><a class="header" href="#intermediate-path-components">Intermediate path components</a></h3>
<p>Any directory that is not preserved itself but is a parent of a preserved file or directory
is called an intermediate path component here. Regarding the ownership and permissions of these
intermediate path components, the following needs to be considered.</p>
<h4 id="intermediate-path-components-of-user-specific-files-and-directories"><a class="header" href="#intermediate-path-components-of-user-specific-files-and-directories">Intermediate path components of user-specific files and directories</a></h4>
<p>Parent directories of a preserved user-specific file or directory are created with the respective
user as their owner and permissions <code>0755</code>. This is the case for all intermediate path components
up to, but not including, the user's home directory.</p>
<p><strong>Example</strong></p>
<p>Consider the following preservation config:</p>
<pre><code class="language-nix">preservation.preserveAt."/persistent".users.alice.directories = [
  ".local/state/nvim"
];
</code></pre>
<p>This config will cause preservation to configure a bind-mount for the subdirectory <code>nvim</code>, causing its
contents to be preserved. The intermediate path components <code>.local</code> and <code>state</code> will be created if
necessary, but their contents are not preserved. Owner is set to <code>alice</code>, group to alice's primary
group, i.e. <code>users.users.alice.group</code> and the mode is set to <code>0755</code>.</p>
<h4 id="intermediate-path-components-of-system-wide-files-and-directories"><a class="header" href="#intermediate-path-components-of-system-wide-files-and-directories">Intermediate path components of system-wide files and directories</a></h4>
<p>For system-wide files and directories, missing components of a preserved path that do not already exist,
are created by systemd-tmpfiles with default ownership <code>root:root</code> and mode <code>0755</code>.</p>
<p>Should such directories require different ownership or mode, the intended way to create and configure them
is via systemd-tmpfiles directly.</p>
<p><strong>Example</strong></p>
<p>Consider a preserved file <code>/foo/bar/baz</code>:</p>
<pre><code class="language-nix">preservation.preserveAt."/persistent".files = [
  { file = "/foo/bar/baz"; user = "baz"; group = "baz"; };
];
</code></pre>
<p>This would create the file with desired ownership on both the volatile and persistent volumes.
However, the parent directories that did not exist before, i.e. <code>/foo</code> and <code>/foo/bar</code>, are
created with ownership <code>root:root</code> and mode <code>0755</code>.</p>
<p>Preservations allows the configuration of immediate parents, so the permissions for <code>/foo/bar</code>
can be configured:</p>
<pre><code class="language-nix">preservation.preserveAt."/persistent".files = [
  {
    file = "/foo/bar/baz"; user = "baz"; group = "baz";
    configureParent = true;
    parent.user = "baz";
    parent.group = "bar";
  };
];
</code></pre>
<p>Now the parent directory <code>/foo/bar</code> is configured with ownership <code>baz:bar</code>. But the first
path component <code>/foo</code> still has systemd-tmpfiles' default ownership and the configuration
becomes quite convoluted.</p>
<p><strong>Solution</strong></p>
<p>To create or configure intermediate path components of a persisted path, systemd-tmpfiles
may be used directly:</p>
<pre><code class="language-nix"># configure preservation of single file
preservation.preserveAt."/persistent".files = [
  { file = "/foo/bar/baz"; user = "baz"; group = "bar"; };
];

# create and configure parents of preserved file on the volatile volume with custom permissions
# The Preservation module also uses `settings.preservation` here.
systemd.tmpfiles.settings.preservation = {
  "/foo".d = { user = "foo"; group = "bar"; mode = "0775"; };
  "/foo/bar".d = { user = "bar"; group = "bar"; mode = "0755"; };
};
</code></pre>
<p>See <a href="https://www.freedesktop.org/software/systemd/man/latest/tmpfiles.d.html">tmpfiles.d(5)</a>
for available configuration options.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="library-and-testing"><a class="header" href="#library-and-testing">Library and Testing</a></h1>
<h2 id="library"><a class="header" href="#library">Library</a></h2>
<p>The functionality that is used in the module to discover the files and
directories that are persisted and to generate the corresponding tmpfiles
config and mount units is available from <a href="https://github.com/nix-community/preservation/blob/main/lib.nix"><code>lib.nix</code></a>.
It is also available from the flake <code>lib</code> output.</p>
<p>In both cases it needs to be instantiated with the nixpkgs <code>lib</code>.</p>
<h2 id="testing"><a class="header" href="#testing">Testing</a></h2>
<p>The integration test(s) can be found in <a href="https://github.com/nix-community/preservation/blob/main/tests">/tests</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
